#!/usr/bin/env node
/**
 * Environment Variables Script Generator
 * 
 * Generates setup scripts for environment variables based on configuration.
 * Usage: node scripts/generate-env-script.js <service-name>
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_DIR = path.resolve(__dirname, '..');

// Environment variable definitions
const ENV_DEFINITIONS = {
  supabase: {
    name: 'Supabase',
    description: 'Supabase database and authentication',
    required: [
      {
        key: 'VITE_SUPABASE_URL',
        description: 'Supabase project URL',
        defaultValue: 'https://nonaqhllakrckbtbawrb.supabase.co',
        getFrom: 'https://supabase.com/dashboard/project/nonaqhllakrckbtbawrb/settings/api-keys',
        validation: (value) => value.startsWith('https://') && value.includes('.supabase.co'),
      },
      {
        key: 'VITE_SUPABASE_ANON_KEY',
        description: 'Supabase publishable/anonymous key',
        defaultValue: '',
        getFrom: 'https://supabase.com/dashboard/project/nonaqhllakrckbtbawrb/settings/api-keys',
        validation: (value) => value.startsWith('sb_publishable_') || value.startsWith('eyJ'),
      },
    ],
    optional: [],
  },
  fourthwall: {
    name: 'Fourthwall Storefront',
    description: 'Fourthwall products API (shop)',
    required: [
      {
        key: 'FOURTHWALL_STOREFRONT_TOKEN',
        description: 'Fourthwall Storefront token (server/API)',
        defaultValue: '',
        getFrom: 'https://thelostandunfounds-shop.fourthwall.com/admin/dashboard/settings/for-developers',
        validation: (value) => value.length > 10,
      },
      {
        key: 'VITE_FOURTHWALL_STOREFRONT_TOKEN',
        description: 'Fourthwall Storefront token (client fallback)',
        defaultValue: '',
        getFrom: 'https://thelostandunfounds-shop.fourthwall.com/admin/dashboard/settings/for-developers',
        validation: (value) => value.length > 10,
      },
    ],
    optional: [],
  },
  turnstile: {
    name: 'Cloudflare Turnstile',
    description: 'Bot protection for forms',
    required: [],
    optional: [
      {
        key: 'VITE_TURNSTILE_SITE_KEY',
        description: 'Turnstile site key (frontend)',
        defaultValue: '',
        getFrom: 'https://dash.cloudflare.com/?to=/:account/turnstile',
        validation: (value) => value.startsWith('0x') || value.length > 10,
      },
    ],
  },
  telegram: {
    name: 'Telegram Bot',
    description: 'Telegram bot integration',
    required: [],
    optional: [
      {
        key: 'TELEGRAM_BOT_TOKEN',
        description: 'Telegram bot token',
        defaultValue: '',
        getFrom: 'https://t.me/botfather',
        validation: (value) => value.includes(':') && value.length > 20,
      },
      {
        key: 'TELEGRAM_ALLOWED_USER_IDS',
        description: 'Comma-separated allowed user IDs',
        defaultValue: '',
        getFrom: 'Telegram user settings',
        validation: () => true, // Optional, no strict validation
      },
    ],
  },
  openai: {
    name: 'OpenAI',
    description: 'OpenAI API for voice transcription',
    required: [],
    optional: [
      {
        key: 'OPENAI_API_KEY',
        description: 'OpenAI API key',
        defaultValue: '',
        getFrom: 'https://platform.openai.com/api-keys',
        validation: (value) => value.startsWith('sk-'),
      },
    ],
  },
  paypal: {
    name: 'PayPal',
    description: 'PayPal MCP Server and API integration',
    required: [
      {
        key: 'PAYPAL_ACCESS_TOKEN',
        description: 'PayPal Access Token (for MCP Server)',
        defaultValue: '',
        getFrom: 'Run: node generate-paypal-token.js',
        validation: (value) => value.length > 20,
      },
      {
        key: 'PAYPAL_ENVIRONMENT',
        description: 'PayPal Environment (SANDBOX or PRODUCTION)',
        defaultValue: 'PRODUCTION',
        getFrom: 'Your PayPal Developer Dashboard',
        validation: (value) => ['SANDBOX', 'PRODUCTION', 'LIVE'].includes(value.toUpperCase()),
      },
    ],
    optional: [],
  },
};

function generateScript(serviceName) {
  const config = ENV_DEFINITIONS[serviceName];

  if (!config) {
    console.error(`âŒ Unknown service: ${serviceName}`);
    console.error(`Available services: ${Object.keys(ENV_DEFINITIONS).join(', ')}`);
    process.exit(1);
  }

  const scriptContent = `#!/bin/bash
# ${config.name} Environment Variables Setup Script
# Generated by scripts/generate-env-script.js
# Usage: ./scripts/setup-${serviceName}-env.sh

set -e

SCRIPT_DIR="\$(cd "\$(dirname "\${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="\$(cd "\$SCRIPT_DIR/.." && pwd)"

cd "\$PROJECT_DIR"

echo "ðŸ” ${config.name} Environment Setup"
echo ""
echo "ðŸ“‹ ${config.description}"
echo ""

${config.required.map((env, index) => `
# ${env.description}
echo "ðŸ“ ${env.key}"
echo "   Get from: ${env.getFrom}"
${env.defaultValue ? `echo "   Default: ${env.defaultValue}"` : ''}
read -p "Enter ${env.key}${env.defaultValue ? ` (or press Enter for default)` : ''}: " ${env.key.replace(/[^A-Z0-9_]/g, '_')}_INPUT

${env.defaultValue ? `${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE="\${${env.key.replace(/[^A-Z0-9_]/g, '_')}_INPUT:-${env.defaultValue}}"` : `${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE="\${${env.key.replace(/[^A-Z0-9_]/g, '_')}_INPUT}"`}

if [ -z "\$${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE" ]; then
  echo "âŒ Error: ${env.key} cannot be empty"
  exit 1
fi
`).join('')}

${config.optional.length > 0 ? `
# Optional variables
echo ""
read -p "Do you want to set optional variables? (y/n): " SET_OPTIONAL
` : ''}

${config.optional.map((env, index) => `
if [ "\$SET_OPTIONAL" = "y" ] || [ "\$SET_OPTIONAL" = "Y" ]; then
  echo ""
  echo "ðŸ“ ${env.key} (Optional)"
  echo "   ${env.description}"
  echo "   Get from: ${env.getFrom}"
  read -p "Enter ${env.key} (or press Enter to skip): " ${env.key.replace(/[^A-Z0-9_]/g, '_')}_INPUT
  ${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE="\${${env.key.replace(/[^A-Z0-9_]/g, '_')}_INPUT}"
fi
`).join('')}

# Build env file content
ENV_CONTENT="# ${config.name} Configuration
# Generated by setup-${serviceName}-env.sh
"

${config.required.map(env => `ENV_CONTENT+="${env.key}=\$${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE\\n"
`).join('')}

${config.optional.map(env => `
if [ "\$SET_OPTIONAL" = "y" ] || [ "\$SET_OPTIONAL" = "Y" ] && [ -n "\$${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE" ]; then
  ENV_CONTENT+="${env.key}=\$${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE\\n"
fi
`).join('')}

# Append to .env.local (or create if doesn't exist)
if [ -f .env.local ]; then
  # Remove existing entries for these variables
  ${[...config.required, ...config.optional].map(env => `
  grep -v "^${env.key}=" .env.local > .env.local.tmp || true
  mv .env.local.tmp .env.local
  `).join('')}
fi

echo -e "\$ENV_CONTENT" >> .env.local

echo ""
echo "âœ… ${config.name} environment variables added to .env.local!"

# Ask about Vercel
echo ""
read -p "Do you want to set Vercel environment variables? (y/n): " SET_VERCEL

if [ "\$SET_VERCEL" = "y" ] || [ "\$SET_VERCEL" = "Y" ]; then
  echo ""
  echo "ðŸ” Checking Vercel CLI..."
  
  # Use npx vercel if vercel command not found
  if command -v vercel &> /dev/null; then
    VERCEL_CMD="vercel"
  else
    VERCEL_CMD="npx vercel"
    echo "âš ï¸  Using npx vercel (Vercel CLI not installed globally)"
  fi
  
  echo "ðŸ“ Setting Vercel environment variables..."
  
${config.required.map(env => `
  # Set ${env.key}
  echo "\$${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE" | \$VERCEL_CMD env add ${env.key} production preview development 2>/dev/null || \\
    echo "âš ï¸  ${env.key} might already be set. Use '\$VERCEL_CMD env ls' to check."
`).join('')}

${config.optional.map(env => `
  if [ -n "\$${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE" ]; then
    echo "\$${env.key.replace(/[^A-Z0-9_]/g, '_')}_VALUE" | \$VERCEL_CMD env add ${env.key} production preview development 2>/dev/null || \\
      echo "âš ï¸  ${env.key} might already be set. Use '\$VERCEL_CMD env ls' to check."
  fi
`).join('')}

  echo ""
  echo "âœ… Vercel environment variables set!"
  echo "   Run '\$VERCEL_CMD --prod' to redeploy with new variables."
fi

echo ""
echo "âœ… Setup complete!"
echo ""
echo "ðŸ“ Next steps:"
echo "   1. Restart your dev server: npm run dev"
if [ "\$SET_VERCEL" = "y" ] || [ "\$SET_VERCEL" = "Y" ]; then
  if command -v vercel &> /dev/null; then
    echo "   2. Redeploy to Vercel: vercel --prod"
  else
    echo "   2. Redeploy to Vercel: npx vercel --prod"
  fi
fi
echo "   3. Run validation: npm run validate-env"
`;

  const scriptPath = path.join(PROJECT_DIR, 'scripts', `setup-${serviceName}-env.sh`);
  fs.writeFileSync(scriptPath, scriptContent);
  fs.chmodSync(scriptPath, '755');

  console.log(`âœ… Generated script: ${scriptPath}`);
  console.log(`   Run: ./scripts/setup-${serviceName}-env.sh`);
}

// Main
const serviceName = process.argv[2];

if (!serviceName) {
  console.log('Usage: node scripts/generate-env-script.js <service-name>');
  console.log('');
  console.log('Available services:');
  Object.keys(ENV_DEFINITIONS).forEach(key => {
    console.log(`  - ${key}: ${ENV_DEFINITIONS[key].name}`);
  });
  process.exit(1);
}

generateScript(serviceName);

