# Cursor Rules for THE LOST+UNFOUNDS

## SKILL UTILIZATION RULE - HIGHEST PRIORITY
**Before starting ANY task, you MUST scan the skills directories and read the relevant SKILL.md files.**

Skills are located in:
- `.agent/skills/*/SKILL.md`
- `skills/*/SKILL.md`

### Mandatory Keyword-to-Skill Mapping
When the user's request involves any of these domains, you MUST `view_file` the corresponding SKILL.md BEFORE writing any code or making changes:

| Keywords / Domain | Required Skill(s) |
|---|---|
| email, newsletter, send, campaign, branding, outreach | `brand-email-manager`, `outreach-ops` |
| admin, dashboard, analytics | `admin-ops` |
| affiliate, commission, tracking, Amazon links | `affiliate-ops`, `affiliate-program` |
| blog, publish, post, SQL script | `blog-publishing` |
| shop, product, checkout, PayPal, order, payment | `commerce-engine`, `paypal-sandbox` |
| gallery, photos, upload, sync, Google Drive | `gallery-ops`, `gallery-sync-troubleshooting` |
| UI, design, components, styling, CSS | `noir-design`, `bento-design`, `no-border-design` |
| modal, overlay, z-index, popup | `modal-z-index-manager` |
| database, migration, RLS, schema, Supabase | `infra-ops`, `verify-schema` |
| environment variables, secrets, .env | `secure-env-manager`, `verify-env` |
| deploy, production, dev server, build | `dev-parity-guard`, `fix-dev-server` |
| refactor, cleanup, technical debt | `code-refactor` |
| revenue, earnings, transactions | `revenue-data-validator` |
| browser, testing, UI verification | `smart-browsing`, `browser-ops-guard`, `verify_ui_changes` |
| Google Auth, OAuth, login | `fix-google-auth` |
| clock, stopwatch, timer widget | `dashboard-clock-interaction` (in `skills/`) |
| Google service account, photographer | `gallery-agent-management` (in `skills/`) |
| PayPal credentials, verification | `paypal-verify` (in `skills/`), `fix-paypal-mcp` |

### Rules
1. **Read FIRST, code SECOND.** Never start implementation before consulting relevant skills.
2. **Multiple skills may apply.** If a task spans multiple domains (e.g., "send a newsletter with affiliate links"), read ALL relevant skills.
3. **When in doubt, check.** If you're unsure whether a skill applies, read it anyway — it's cheaper than redoing work.
4. **Skills override assumptions.** If a skill contradicts what you think is correct, follow the skill.
5. **Log skill usage.** When starting a task, mention which skills you consulted so the user can verify.

## TEXT ALIGNMENT RULE - CRITICAL
**NEVER change text alignment to center or justify. ALWAYS use left alignment.**

- Blog post content MUST be `text-left` (NOT `text-center`, NOT `text-justify`)
- Blog post paragraphs MUST be `text-left`
- Blog analysis components MUST be `text-left`
- Headers and titles can be `text-left` or centered based on design, but body text is ALWAYS `text-left`
- If you see `text-justify` or `text-center` on blog content, change it to `text-left`
- DO NOT change alignment unless explicitly asked by the user
- This applies to: BlogPost.tsx, BlogAnalysis.tsx, and any blog-related components

## BLOG POST FORMATTING VERIFICATION RULE - CRITICAL
**ALWAYS check the live URL first, NOT the SQL file, when verifying blog post formatting.**

- Before making any formatting changes, check the actual live blog post URL: `https://www.thelostandunfounds.com/thelostarchives/[slug]`
- Use `curl` or fetch the live page to see how content actually renders
- The SQL file is just the source - the live page shows the real formatting
- Remove "⸻" characters from content - they should NOT appear in blog posts
- Section breaks should use proper paragraph spacing, not "⸻" characters

## BLOG POST PUBLISHING RULE - FOLLOW EVERY TIME

When the user asks to publish a blog post, you MUST follow these steps in order:

### STEP 1: Create SQL File
- Create the SQL file in `sql/create-blog-post-[slug].sql`
- Create the same file in `public/sql/create-blog-post-[slug].sql`
- The SQL file must:
  - Handle multiple schema versions (published field, author_id vs user_id, etc.)
  - Use the pattern from existing blog post SQL files
  - Include proper title, slug, content, excerpt, SEO fields
  - Set published=true and status='published'
  - **CRITICAL: NEVER use ON CONFLICT (slug) - the slug column may not have a unique constraint**
  - **MUST use check-and-insert/update pattern:**
    1. Declare `existing_post_id UUID;` in the DECLARE block
    2. Check if post exists: `SELECT id INTO existing_post_id FROM blog_posts WHERE slug = '[slug]' LIMIT 1;`
    3. For each INSERT statement, wrap it in: `IF existing_post_id IS NOT NULL THEN UPDATE ... ELSE INSERT ... END IF;`
  - This pattern works regardless of whether a unique constraint exists on the slug column

### STEP 2: Update SQL.tsx
- Open `src/pages/SQL.tsx`
- Add fetch code to load the new SQL file (after the last blog post fetch)
- Add the script to the `allScripts` array (order in array doesn't matter - scripts are auto-sorted by createdAt):
  - name: Blog post title
  - filename: create-blog-post-[slug].sql
  - content: The fetched content
  - description: Clear description of what the script does
  - createdAt: getScriptTimestamp('create-blog-post-[slug].sql')
- **CRITICAL: Scripts are automatically sorted by createdAt timestamp (newest first)**
- **New scripts with current timestamps will automatically appear at the top of the page**
- For code organization, you can add new scripts near the top of the array, but the display order is determined by createdAt

### STEP 3: Update API Endpoint
- Open `api/sql/latest.ts`
- Add the new SQL file path to the `SQL_FILES` array

### STEP 4: Commit Changes
- Stage all changed files
- Commit with descriptive message

### STEP 5: Merge to Production
- Checkout `main` branch
- Pull latest from `origin/main`
- Merge the cursor branch into `main`
- Push to `origin/main` to deploy

### STEP 6: Verify Deployment
- The SQL file MUST be accessible at: `https://www.thelostandunfounds.com/sql/create-blog-post-[slug].sql`
- The script MUST appear on the page: `https://www.thelostandunfounds.com/sql`
- Verify the script shows up in the list with copy functionality

### CRITICAL RULES:
1. ALWAYS use the exact URL format: `https://www.thelostandunfounds.com/sql/` (lowercase "sql")
2. ALWAYS merge to `main` branch and push to deploy
3. ALWAYS verify the script appears on the `/sql` page after deployment
4. NEVER skip any of these steps
5. The `/sql` page is the deployment interface - scripts must appear there

### The Purpose:
The `/sql` page at `https://www.thelostandunfounds.com/sql` is where SQL scripts are displayed so they can be copied and executed in Supabase SQL Editor. Every blog post SQL script MUST be accessible and visible on this page.

## DEPLOYMENT VERIFICATION RULE - CRITICAL
**ALWAYS verify deployments are successful before marking tasks as complete.**

When creating any deployment (Vercel, Railway, or other platforms), you MUST:

1. ✅ **Check Deployment Status** - Verify state is "READY", "SUCCESS", or "ACTIVE"
2. ✅ **Review Build Logs** - Check for errors, warnings, or failures
3. ✅ **Verify Deployment URL** - Test that the deployed application is accessible
4. ✅ **Confirm Functionality** - Ensure key features work on the deployed version

**CRITICAL REMINDERS:**
- ❌ **NEVER** mark a deployment as complete without verification
- ❌ **NEVER** skip checking build logs
- ❌ **NEVER** assume deployment is successful based on creation alone
- ✅ **ALWAYS** verify status, logs, and URL
- ✅ **ALWAYS** wait for final state (not intermediate states like "BUILDING")
- ✅ **ALWAYS** report verification results clearly

For detailed verification workflow and code examples, see: `.cursor/rules/deployment-verification-rule.mdc`

## BLOG POST STYLE GUIDE - CRITICAL
**ALWAYS follow the style guide when formatting blog posts. See `BLOG_POST_STYLE_GUIDE.md` for complete documentation.**

### Key Style Rules:
1. **Book Title Linking**: Maximum 2 links per book (1 in intro, 1 in section). After 2 links, display as bold title case text only.
2. **Book Title Formatting**: Book titles MUST preserve the author's original case formatting from the article content. If author wrote "THE HOBBIT" it displays as "THE HOBBIT", if "The Hobbit" it displays as "The Hobbit". All book titles are bold. Linked titles are underlined.
3. **Author Name in Disclosure**: Author names in Amazon Affiliate Disclosure MUST be UPPERCASE and bold.
4. **Excerpt Display**: Excerpt/preview text displays in header after title and date (if available).
5. **Header Detection**: Headers are auto-detected (short, title case, no ending punctuation). Book titles in headers can be linked.
6. **Section Detection**: Book sections are detected by looking backwards for headings containing book titles (fuzzy matching, no colon required).
7. **Text Alignment**: All body text MUST be left-aligned. Disclosure text is justified (only exception).

### Implementation:
- Book title matching uses fuzzy matching to handle case, punctuation, and apostrophe variations
- Section detection uses normalized title matching (doesn't require exact case or colons)
- Author name formatting is handled by `formatDisclosure()` function
- All formatting is automatic based on content structure

**For complete documentation, see: `BLOG_POST_STYLE_GUIDE.md`**

## EMAIL SENDING RULE - CRITICAL
- NEVER respond that you cannot send email for THE LOST+UNFOUNDS; use the existing Zoho Mail integrations.
- Preferred test path: POST `https://www.thelostandunfounds.com/api/admin/send-welcome-emails` with body `{"testEmail":"target@example.com"}`.
- Use shared helpers in `lib/api-handlers/_zoho-email-utils.ts` (or handlers that import it) to send mail.
- If a send fails, surface the Zoho API error details (status/text) instead of declining.
- When running locally, ensure env vars exist: `ZOHO_CLIENT_ID`, `ZOHO_CLIENT_SECRET`, `ZOHO_REFRESH_TOKEN`, and `ZOHO_FROM_EMAIL` (or `ZOHO_EMAIL`).

## EMAIL BRANDING RULE - CRITICAL
**Before writing, modifying, or debugging ANY email-sending code, you MUST read `.agent/skills/brand-email-manager/SKILL.md` FIRST.**

- ALL outgoing emails MUST use the branded template functions from `lib/email-template.ts`:
  - **Newsletters** → `generateNewsletterEmail(bodyContent, subscriberEmail)`
  - **Transactional** → `generateTransactionalEmail(bodyContent)`
  - **Custom** → `wrapEmailContent(bodyContent, options)`
- ❌ NEVER use `processEmailContent` alone — it does NOT include the logo/banner
- ❌ NEVER hardcode raw HTML email templates in handlers
- ✅ ALWAYS verify the handler uses the correct function BEFORE sending a test
- ✅ ALWAYS deploy handler changes to production BEFORE running test sends against the live API
- If you modify email handler code, follow the `/send-email` workflow in `.agent/workflows/send-email.md`

## NEWSLETTER RESEND RULE - CRITICAL
- Standard operating procedure to resend or test the latest newsletter:
  1) Load Supabase envs (`.env.local`) and use `SUPABASE_SERVICE_ROLE_KEY` with `SUPABASE_URL` to query `newsletter_campaigns` ordered by `created_at` desc limit 1.
  2) Inject the Getting Started CTA link (`https://www.thelostandunfounds.com/blog/getting-started`) into `content_html` before the footer/hr if not already present.
  3) Send via POST `https://www.thelostandunfounds.com/api/newsletter/send` with `subject`, `content`, `contentHtml` (CTA-injected), and `testEmail` when testing.
  4) For a full resend, omit `testEmail` to target all verified subscribers.
  5) If envs are missing, load from `.env.local` with dotenv; do NOT claim inability—surface missing-env error only if loading fails.

## DASHBOARD CLOCK INTERACTION RULE - CRITICAL
**ALWAYS maintain the specific interaction logic for the dashboard clock widget.**

- **Tapping/Clicking the clock face** MUST cycle through formats: Analog -> Digital (12h) -> Digital (24h).
- **Tapping/Clicking the top label** (e.g., "CLOCK") MUST cycle through modes: Clock -> Stopwatch -> Timer.
- **RESTRICT top label area**: The clickable area for mode switching should be small (e.g., `h-12`) to prevent accidental triggers.
- **STOP PROPAGATION**: Clock face clicks must call `e.stopPropagation()` to prevent unwanted mode switching.
- **NO KEYBOARD EVENTS**: Do not implement keyboard-based format toggling unless specified.
